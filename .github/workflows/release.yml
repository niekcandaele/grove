name: Build & Release

on:
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun test

      - name: Build binaries
        run: |
          VERSION="${{ github.ref_name }}"
          # For main branch builds or PRs, use "next"
          if [ "$VERSION" = "main" ] || [ -z "$VERSION" ]; then
            VERSION="next"
          fi
          bun build --compile --minify --target=bun-linux-x64 --define "GROVE_VERSION=\"$VERSION\"" ./src/index.ts --outfile dist/grove-linux-x64
          bun build --compile --minify --target=bun-linux-arm64 --define "GROVE_VERSION=\"$VERSION\"" ./src/index.ts --outfile dist/grove-linux-arm64
          bun build --compile --minify --target=bun-darwin-x64 --define "GROVE_VERSION=\"$VERSION\"" ./src/index.ts --outfile dist/grove-darwin-x64
          bun build --compile --minify --target=bun-darwin-arm64 --define "GROVE_VERSION=\"$VERSION\"" ./src/index.ts --outfile dist/grove-darwin-arm64
          bun build --compile --minify --target=bun-windows-x64 --define "GROVE_VERSION=\"$VERSION\"" ./src/index.ts --outfile dist/grove-windows-x64.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: |
            dist/grove-linux-x64
            dist/grove-linux-arm64
            dist/grove-darwin-x64
            dist/grove-darwin-arm64
            dist/grove-windows-x64.exe

  e2e:
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: grove-linux-x64
          - os: macos-latest
            binary: grove-darwin-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: dist/

      - name: Make binary executable
        run: chmod +x dist/${{ matrix.binary }}

      - name: Run e2e tests
        run: |
          export GROVE_BIN="$PWD/dist/${{ matrix.binary }}"
          bash tests/e2e/run-tests.sh

  release-next:
    needs: [build, e2e]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: dist/

      - name: Delete existing next release
        run: gh release delete next --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete existing next tag
        run: git push origin :refs/tags/next || true

      - name: Create next release
        run: |
          gh release create next \
            --title "Development Build (next)" \
            --notes "Latest build from main branch. **Not recommended for production.**

          Commit: ${{ github.sha }}
          Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --prerelease \
            dist/grove-linux-x64 \
            dist/grove-linux-arm64 \
            dist/grove-darwin-x64 \
            dist/grove-darwin-arm64 \
            dist/grove-windows-x64.exe
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-stable:
    needs: [build, e2e]
    if: startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/tags/next'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: dist/

      - name: Create release
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            dist/grove-linux-x64 \
            dist/grove-linux-arm64 \
            dist/grove-darwin-x64 \
            dist/grove-darwin-arm64 \
            dist/grove-windows-x64.exe
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
